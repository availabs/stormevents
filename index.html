<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="bower_components/leaflet-sidebar/src/L.Control.Sidebar.css">
    <style>
    html,body{
    	width:100%;
    	height:100%;
      margin:0;
    }
    h4{
        margin:0;
    }
    #map{
    	width:100%;
    	height:100%;
    }
    .storm_event{
        stroke:#f00;

    }
    .storm_event:hover{
        cursor:pointer;

    }
    #tooltip {
        opacity: 1;
        background: white;
        padding: 5px;
        position: absolute;
        z-index: 10;
        visibility: hidden;
        pointer-events: none;
    }
    </style>

  </head>
  <body>
    <div id="map">
        <div id="sidebar">
            <h1>Storm Events</h1>
            <div id="controls">
                <label>Event Type:</label>
                <select id="select_event">
                    <option value="All" selected>All</option>
                    <option value="Hail">Hail</option>
                    <option value="Thunderstorm Wind">Thunderstorm Wind</option>
                    <option value="Flood">Flood</option>
                    <option value="Flash Flood">Flash Flood</option>
                    <option value="Lightning">Lightning</option>
                    <option value="Heavy Rain">Heavy Rain</option>
                    <option value="Tornado">Tornado</option>
                </select>
                <div style="float:bottom">
                    <br>
                    Mapping Data from <a href="http://www.ncdc.noaa.gov/stormevents/">http://www.ncdc.noaa.gov/stormevents/</a><br>
                    Event Property Damage is represented by circle radius.<br>
                    Data is currently incomplete, this is just a proof of concept.<br>
                </div>
            </div>
        </div>
    </div>
    <div id="tooltip">
    </div>
    
  </body>
  <script src="bower_components/jquery/dist/jquery.js"></script>
  <script src="bower_components/d3/d3.min.js"></script>
  <script src="bower_components/leaflet/dist/leaflet.js"></script>
  <script src="bower_components/leaflet-sidebar/src/L.Control.Sidebar.js"></script>
  <script src="d3leaflet-layers.js"></script>
  <script>
    
    /* Basemap Layers */
    var mapquestOSM = L.tileLayer("http://{s}.tiles.mapbox.com/v3/am3081.h0po4e8k/{z}/{x}/{y}.png");
    
    // -- Map Setup
    var map = L.map("map", {
      center: [42.76314586689494,-74.7509765625],
      zoom: 7,
      layers: [mapquestOSM],
      zoomControl: false
    });

    var sidebar = L.control.sidebar('sidebar', {
     position: 'left'
    });

    map.addControl(sidebar);
    sidebar.show();

    // -- Data Processing

    d3.json('stormEvents2000.json',function(err,data){
        //console.log('data',data,data.length)

        var locationEvents = data.filter(function(event){
            return event.BEGIN_LAT != " ";
        })

        var stormEvents = {type:'FeatureCollection',features:[]};
        var filteredEvents = {type:'FeatureCollection',features:[]};
        stormEvents.features = locationEvents.map(function(stormevent){
            return {
                type:"Feature",
                properties:stormevent,
                geometry:{
                  type:"Point",
                  coordinates:[+stormevent.BEGIN_LON,+stormevent.BEGIN_LAT]
                }
            }
        });


        var event_types = [];
        stormEvents.features.forEach(function(se){
            //console.log(se.properties.EVENT_TYPE);
            if(event_types.indexOf(se.properties.EVENT_TYPE) < 0 ){
                event_types.push(se.properties.EVENT_TYPE);
            }
        });

        console.log(event_types);

        var property_damages = [];
        stormEvents.features.forEach(function(se){
            if(property_damages.indexOf(se.properties.DAMAGE_PROPERTY_NUM) < 0 ){
                property_damages.push(+se.properties.DAMAGE_PROPERTY_NUM);
            }
        });

        
        var event_select = d3.select('#select_event')

        
           
        $('#select_event').on('change',function(d,e){
            
            var type = $(this).val();

            console.log(type);

            if(type === 'All'){
            
                stormLayer.externalUpdate( stormEvents );
            
            }else{
                
                filteredEvents.features = stormEvents.features.filter(function(feat){
                    return feat.properties.EVENT_TYPE == type;
                });
                console.log('test',type,filteredEvents.features.length)
                stormLayer.externalUpdate( filteredEvents );
            }
            

        })
        

        var damageScale = d3.scale.sqrt()
            .domain([0,1000000])
            .range([2,30]);
        
        var radiusScale = function(d){

            //console.log(damageScale(d.properties.DAMAGE_PROPERTY_NUM))

            return damageScale(d.properties.DAMAGE_PROPERTY_NUM)
        }
        // options
        //     .enter()
        //     .append('option')
        //     .attr('test',function(d){return d;}) 
                       

        var options = {
            layerId:'storms',
            classed:'storm_event',
            type:'point',
            attr_functions:{
                'r': radiusScale
            },
            event_functions:{
                mouseover:function(d){
                    var content = '<h4>'+d.properties.EVENT_TYPE+'</h4>';
                    content += '<table class="table">';
                    content += '<tr><td>Property Damage</td><td>'+d.properties.DAMAGE_PROPERTY_NUM+'</td></tr>';
                    content += '<tr><td>Crops Damage</td><td>'+d.properties.DAMAGE_CROPS_NUM+'</td></tr>';
                    content += '<tr><td>CZ Name</td><td>'+d.properties.CZ_NAME_STR+'</td></tr>';
                    content += '<tr><td>Begin Date</td><td>'+d.properties.BEGIN_DATE+'</td></tr>';
                    content += '<tr><td>Event ID</td><td>'+d.properties.EVENT_ID+'</td></tr>';
                    content += '</table>';


                    d3.select("#tooltip")
                        .style("visibility", "visible")
                        .style("top", function () { return (d3.event.pageY - 130)+"px"})
                        .style("left", function () { return (d3.event.pageX - 230)+"px";})
                        .html(content)

                },
                mouseout:function(d){
                        d3.select("#tooltip")
                        .style("visibility", "hidden")
                }   
            }

        };

        var stormLayer = new L.GeoJSON.d3(stormEvents,options)
        map.addLayer(stormLayer);

    });// end d3.json


     
    

  </script>
</html>